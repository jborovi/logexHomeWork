# queries
# task 2
# SELECT TOP 1 tp.patientid as Patient_id, tp.firstname as First_name, tp.lastname as Last_name, sum(tp2.price) as cost FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id WHERE YEAR(ttd.date_performed) = YEAR(GETDATE()) - 1 GROUP BY tp.patientid, tp.firstname, tp.lastname ORDER by sum(tp2.price) desc;
# task 3
# SELECT tmt.patient_id as Patient_id, sum(tp2.price) as cost, YEAR(ttd.date_performed) as year FROM test_medical_trajectory tmt INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id GROUP BY tmt.patient_id, YEAR(ttd.date_performed) ORDER BY tmt.patient_id ASC, year(ttd.date_performed) ASC
# task 4
# SELECT ttc.category_id as 'category Id', COALESCE (sum(tp2.price), 0) as Cost, COALESCE (cast (MONTH(ttd.date_performed) as varchar), 'Not performed') as Month FROM test_medical_trajectory tmt INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id RIGHT JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts ON ta.treatment_subcategory_id = tts.subcategory_id RIGHT JOIN test_treatment_categories ttc ON ttc.category_id = tts.treatment_category_id  WHERE YEAR(ttd.date_performed) = YEAR(GETDATE()) - 1 OR ttd.date_performed is NULL GROUP BY ttc.category_id, MONTH(ttd.date_performed) ORDER by ttc.category_id , MONTH(ttd.date_performed) ASC ;
# task 5
# SELECT category_id AS 'category Id', patient_id as patientId FROM ( SELECT ROW_NUMBER() OVER(PARTITION BY tmt.patient_id ORDER BY tmt.patient_id, SUM(tp2.price) DESC, ttc2.rank DESC) AS group_row, tmt.patient_id as patient_id, ttc2.category_id, tmt.traject_id, ttd.activity_id,  SUM(tp2.price) as sum_price, ttc2.rank FROM test_medical_trajectory tmt  INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id  GROUP BY tmt.patient_id, ttc2.category_id, tmt.traject_id, ttd.activity_id, ttc2.rank) b WHERE b.group_row = 1 ORDER BY patient_id, category_id


# SELECT  a.category_id, tp3.patientid, SUM(a.sum_price), a.rank from test_patients as tp3 inner join (SELECT tp.patientid as patientid, ttc2.category_id , tp2.price as sum_price, ttc2.rank as rank FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id) a ON a.patientid = tp3.patientid GROUP BY tp3.patientid, a.category_id, a.rank ORDER by tp3.patientid ASC, SUM(a.sum_price) DESC, a.rank DESC
#
# SELECT  a.category_id, tp3.patientid, SUM(a.sum_price), a.rank from test_patients as tp3 inner join (SELECT tp.patientid as patientid, ttc2.category_id , SUM(tp2.price) as sum_price, ttc2.rank as rank FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id) a ON a.patientid = tp3.patientid GROUP BY tp3.patientid, a.category_id, a.rank ORDER by tp3.patientid ASC, SUM(a.sum_price) DESC, a.rank DESC
#
# SELECT tp3.patientid, a.category_id, MAX(a.sum_price) FROM test_patients tp3 INNER JOIN(SELECT tp.patientid as patientid, ttc2.category_id, SUM(tp2.price) as sum_price, ttc2.rank as rank FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id GROUP BY tp.patientid, ttc2.category_id, ttc2.rank) a ON a.patientid = tp3.patientid  group by tp3.patientid, a.category_id, a.rank ORDER by tp3.patientid, a.rank ASC, a.category_id
#
# SELECT tp3.patientid as patientid, a.category_id, MAX(a.sum_price), a.rank FROM test_patients tp3 INNER JOIN(SELECT tp.patientid as patientid, ttc2.category_id, SUM(tp2.price) as sum_price, ttc2.rank as rank FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id GROUP BY tp.patientid, ttc2.category_id, ttc2.rank) a ON a.patientid = tp3.patientid  group by tp3.patientid, a.category_id, a.rank
#
# select * from (SELECT tp3.patientid as patientid, a.category_id, MAX(a.sum_price) as max_price, a.rank FROM test_patients tp3 INNER JOIN(SELECT tp.patientid as patientid, ttc2.category_id, SUM(tp2.price) as sum_price, ttc2.rank as rank FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id GROUP BY tp.patientid, ttc2.category_id, ttc2.rank) a ON a.patientid = tp3.patientid  group by tp3.patientid, a.category_id, a.rank) b ORDER BY b.patientid ASC, b.rank DESC
#
# SELECT * FROM (SELECT tp3.patientid as patientid, a.category_id, MAX(a.sum_price) max_price, a.rank FROM test_patients tp3 INNER JOIN(SELECT tp.patientid as patientid, ttc2.category_id, SUM(tp2.price) as sum_price, ttc2.rank as rank FROM test_patients tp INNER JOIN test_medical_trajectory tmt ON tp.patientid = tmt.patient_id INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id GROUP BY tp.patientid, ttc2.category_id, ttc2.rank) a ON a.patientid = tp3.patientid  group by tp3.patientid, a.category_id, a.rank) b ORDER BY b.patientid ASC, b.max_price DESC, b.rank DESC
#
# SELECT tmt.patient_id as patient_id, ttc2.category_id, SUM(tp2.price) as sum_price, ttc2.rank as rank FROM test_medical_trajectory tmt  INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id GROUP BY tmt.patient_id, ttc2.category_id, ttc2.rank order by tmt.patient_id, sum_price DESC, rank DESC
#
# SELECT ROW_NUMBER() OVER(PARTITION BY tmt.patient_id ORDER BY tmt.patient_id) AS ROW_NUMBER, tmt.patient_id as patient_id, ttc2.category_id, tmt.traject_id, ttd.activity_id,  SUM(tp2.price) as sum_price FROM test_medical_trajectory tmt  INNER JOIN test_trajectory_detail ttd ON ttd.traject_id = tmt.traject_id INNER JOIN test_activities ta ON ttd.activity_id = ta.id INNER JOIN test_prices tp2 ON ta.id = tp2.activity_id INNER JOIN test_treatment_subcategories tts on tts.subcategory_id = ta.treatment_subcategory_id INNER join test_treatment_categories ttc2 on ttc2.category_id = tts.treatment_category_id GROUP BY tmt.patient_id, ttc2.category_id, tmt.traject_id, ttd.activity_id, ttc2.rank  ORDER BY tmt.patient_id, sum_price DESC, ttc2.rank DESC
